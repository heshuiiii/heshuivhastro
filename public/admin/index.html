<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>博客管理后台</title>
  
  <style>
    /* 重置和基础样式 */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
    }
    
    /* CMS根容器样式覆盖 */
    .nc-root {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif !important;
    }
    
    /* 移动端响应式优化 */
    @media (max-width: 768px) {
      .nc-root {
        font-size: 14px !important;
      }
      
      .nc-toolbar {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }
      
      .nc-toolbar button {
        min-width: 40px !important;
        min-height: 40px !important;
        padding: 8px !important;
        font-size: 14px !important;
      }
      
      .nc-controlPane-widget input[type="text"], 
      .nc-controlPane-widget textarea, 
      .nc-controlPane-widget select {
        font-size: 16px !important;
        padding: 12px !important;
        border-radius: 8px !important;
        border: 2px solid #e5e7eb !important;
        width: 100% !important;
        transition: all 0.2s ease !important;
      }
      
      .nc-controlPane-widget input[type="text"]:focus, 
      .nc-controlPane-widget textarea:focus, 
      .nc-controlPane-widget select:focus {
        border-color: #3b82f6 !important;
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
      }
      
      .nc-entryEditor {
        padding: 16px !important;
      }
      
      .nc-entryEditor-widget {
        margin-bottom: 16px !important;
      }
      
      .nc-sidebar {
        width: 100% !important;
        position: relative !important;
      }
      
      .nc-entryEditor-widgetTop button {
        padding: 8px 16px !important;
        font-size: 14px !important;
        min-height: 40px !important;
      }
    }
    
    @media (min-width: 769px) and (max-width: 1024px) {
      .nc-root {
        font-size: 15px !important;
      }
      
      .nc-entryEditor {
        padding: 24px !important;
      }
    }
    
    @media (min-width: 1025px) {
      .nc-entryEditor {
        max-width: none !important;
        padding: 32px !important;
      }
    }
    
    /* 预览容器样式 */
    .preview-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6;
      color: #374151;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
      min-height: 100vh;
      padding: 16px;
    }
    
    .preview-card {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      overflow: hidden;
    }
    
    .preview-header {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }
    
    .preview-title {
      font-size: 2rem;
      font-weight: bold;
      margin: 0 0 8px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .preview-subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin: 0;
    }
    
    .preview-content {
      padding: 24px;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      border: 1px solid #e2e8f0;
    }
    
    @media (min-width: 640px) {
      .info-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      .info-item-full {
        grid-column: 1 / -1;
      }
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    @media (max-width: 639px) {
      .info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
    }
    
    .info-label {
      font-weight: 600;
      color: #475569;
      font-size: 0.9rem;
    }
    
    .info-value {
      font-family: 'SF Mono', Consolas, monospace;
      color: #1e293b;
      font-size: 0.875rem;
      background: white;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      word-break: break-all;
    }
    
    .info-value.category {
      background: #dbeafe;
      color: #1e40af;
      border-color: #93c5fd;
    }
    
    .info-value.custom-id {
      background: #fef3c7;
      color: #92400e;
      border-color: #fbbf24;
    }
    
    .info-value.auto-id {
      background: #dcfce7;
      color: #166534;
      border-color: #86efac;
    }
    
    .tags-container {
      margin-bottom: 24px;
    }
    
    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .tag-item {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.875rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
    }
    
    .no-tags {
      color: #9ca3af;
      font-style: italic;
    }
    
    .content-divider {
      height: 2px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      border: none;
      margin: 24px 0;
      border-radius: 1px;
    }
    
    .article-content {
      line-height: 1.7;
    }
    
    .article-content h1 {
      font-size: 1.875rem;
      font-weight: bold;
      margin: 24px 0 16px 0;
      color: #111827;
      border-bottom: 2px solid #3b82f6;
      padding-bottom: 8px;
    }
    
    .article-content h2 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 20px 0 12px 0;
      color: #1f2937;
    }
    
    .article-content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 16px 0 8px 0;
      color: #374151;
    }
    
    .article-content p {
      margin-bottom: 16px;
    }
    
    .article-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 0.875rem;
    }
    
    .article-content pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 16px 0;
    }
    
    .article-content pre code {
      background: transparent;
      padding: 0;
    }
    
    .article-content blockquote {
      border-left: 4px solid #3b82f6;
      padding-left: 16px;
      margin: 16px 0;
      color: #6b7280;
      font-style: italic;
    }
    
    .article-content ul, .article-content ol {
      margin: 16px 0;
      padding-left: 24px;
    }
    
    .article-content li {
      margin-bottom: 8px;
    }
    
    .empty-content {
      color: #9ca3af;
      font-style: italic;
      text-align: center;
      padding: 40px 20px;
      background: #f9fafb;
      border-radius: 8px;
    }
    
    .preview-footer {
      background: #f8fafc;
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      font-size: 0.875rem;
      color: #6b7280;
    }
    
    @media (max-width: 640px) {
      .preview-container {
        padding: 8px;
      }
      
      .preview-header {
        padding: 24px 16px;
      }
      
      .preview-title {
        font-size: 1.5rem;
      }
      
      .preview-content {
        padding: 16px;
      }
      
      .info-grid {
        padding: 16px;
      }
    }

    .id-status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    .id-status-auto {
      background-color: #10b981;
    }
    
    .id-status-custom {
      background-color: #f59e0b;
    }
  </style>
</head>
<body>
  <!-- 加载 Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    // 简单的 Markdown 解析函数
    function parseMarkdown(markdown) {
      if (!markdown) return '';
      
      let html = markdown
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        .replace(/^> (.*)$/gm, '<blockquote>$1</blockquote>')
        .replace(/^\* (.*)$/gm, '<li>$1</li>')
        .replace(/^- (.*)$/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
      
      if (html && !html.startsWith('<')) {
        html = '<p>' + html + '</p>';
      }
      
      return html;
    }

    // 自动生成文章ID
    function generateId() {
      const timestamp = Date.now().toString();
      const random = Math.random().toString(36).substring(2, 8);
      return `post-${timestamp}-${random}`;
    }

    // 检查ID是否为空
    function isEmptyId(id) {
      if (!id) return true;
      if (typeof id !== 'string') return true;
      const trimmed = id.trim();
      return trimmed === '' || trimmed === '""' || trimmed === "''" || trimmed === 'undefined' || trimmed === 'null';
    }

    // 检查ID是否为自动生成格式
    function isAutoGeneratedId(id) {
      if (!id || typeof id !== 'string') return false;
      return /^post-\d{13}-[a-z0-9]{6}$/.test(id.trim());
    }
    
    // 格式化日期
    function formatDate(date) {
      if (!date) return '未设置';
      try {
        return new Date(date).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return '日期格式错误';
      }
    }

    // 处理标签显示
    function renderTags(tags) {
      if (!tags || !Array.isArray(tags) || tags.length === 0) {
        return '<span class="no-tags">暂无标签</span>';
      }
      
      return tags
        .filter(tag => tag && tag.trim())
        .map(tag => `<span class="tag-item">${tag.trim()}</span>`)
        .join('');
    }

    // 渲染ID状态
    function renderIdStatus(id) {
      if (isEmptyId(id)) {
        return `
          <span class="id-status-indicator id-status-auto"></span>
          <span class="info-value auto-id">将自动生成</span>
        `;
      } else if (isAutoGeneratedId(id)) {
        return `
          <span class="id-status-indicator id-status-auto"></span>
          <span class="info-value auto-id">${id}</span>
        `;
      } else {
        return `
          <span class="id-status-indicator id-status-custom"></span>
          <span class="info-value custom-id">${id}</span>
        `;
      }
    }

    // 等待DOM加载完成
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 初始化博客管理后台...');

      // 延迟注册，确保CMS完全加载
      setTimeout(() => {
        try {
          // 注册 preSave 事件 - 自动生成ID
          CMS.registerEventListener({
            name: 'preSave',
            handler: ({ entry }) => {
              console.log('=== preSave 事件触发 ===');
              const data = entry.get('data');
              const currentId = data.get('id');
              
              console.log('当前 ID:', currentId);
              console.log('是否为空:', isEmptyId(currentId));
              
              // 只在ID为空时生成新ID
              if (isEmptyId(currentId)) {
                const newId = generateId();
                console.log('✅ 生成新ID:', newId);
                return entry.get('data').set('id', newId);
              }
              
              console.log('✅ 保持现有ID:', currentId);
              return data;
            }
          });

          // 注册预览模板
          CMS.registerPreviewTemplate('blog', ({ entry }) => {
            const title = entry.getIn(['data', 'title']) || '未命名文章';
            const categories = entry.getIn(['data', 'categories']) || '未分类';
            const tags = entry.getIn(['data', 'tags']);
            const date = entry.getIn(['data', 'date']);
            const id = entry.getIn(['data', 'id']);
            const cover = entry.getIn(['data', 'cover']);
            const rawBody = entry.getIn(['data', 'body']) || '';

            const parsedBody = parseMarkdown(rawBody);

            const html = `
              <div class="preview-container">
                <div class="preview-card">
                  <div class="preview-header">
                    <h1 class="preview-title">${title}</h1>
                    <p class="preview-subtitle">博客文章预览</p>
                  </div>
                  
                  <div class="preview-content">
                    <div class="info-grid">
                      <div class="info-item">
                        <span class="info-label">📝 文章ID</span>
                        <div style="display: flex; align-items: center;">
                          ${renderIdStatus(id)}
                        </div>
                      </div>
                      <div class="info-item">
                        <span class="info-label">📂 分类</span>
                        <span class="info-value category">${categories}</span>
                      </div>
                      <div class="info-item info-item-full">
                        <span class="info-label">🕒 发布时间</span>
                        <span class="info-value">${formatDate(date)}</span>
                      </div>
                      ${cover ? `
                        <div class="info-item info-item-full">
                          <span class="info-label">🖼️ 封面图片</span>
                          <span class="info-value">${cover}</span>
                        </div>
                      ` : ''}
                    </div>

                    <div class="tags-container">
                      <div class="info-label" style="margin-bottom: 8px;">🏷️ 标签</div>
                      <div class="tags-list">
                        ${renderTags(tags)}
                      </div>
                    </div>

                    <hr class="content-divider">

                    <div class="article-content">
                      ${parsedBody || '<div class="empty-content">正文内容为空</div>'}
                    </div>
                  </div>

                  <div class="preview-footer">
                    📊 字数约 ${rawBody.length} 字 • 预计阅读时间 ${Math.max(1, Math.ceil(rawBody.length / 400))} 分钟
                    <br>
                    <small>💡 提示：${isEmptyId(id) ? 'ID为空时将自动生成' : isAutoGeneratedId(id) ? 'ID为自动生成格式' : 'ID为自定义格式'}</small>
                  </div>
                </div>
              </div>
            `;

            return html;
          });

          console.log('✅ 博客管理后台初始化成功！');
        } catch (error) {
          console.error('❌ 初始化 CMS 时出错:', error);
        }
      }, 1000);
    });
  </script>
</body>
</html>
