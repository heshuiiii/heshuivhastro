<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>博客管理后台</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <!-- 在CMS加载后立即注入样式 -->
  <script>
    // 自动生成文章ID的函数
    function generateId() {
      const timestamp = Date.now().toString();
      const random = Math.random().toString(36).substring(2, 8);
      return `post-${timestamp}`;
    }
    // return `post-${timestamp}-${random}`;
    
    // 格式化日期
    function formatDate(date) {
      if (!date) return '未设置';
      try {
        return new Date(date).toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return '日期格式错误';
      }
    }

    // 处理标签显示
    function renderTags(tags) {
      if (!tags || !Array.isArray(tags) || tags.length === 0) {
        return '<span style="color: #9ca3af; font-style: italic;">暂无标签</span>';
      }
      
      return tags
        .filter(tag => tag && tag.trim())
        .map(tag => `<span style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.875rem; font-weight: 500; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); margin-right: 8px; display: inline-block;">${tag.trim()}</span>`)
        .join('');
    }

    // 简单的Markdown解析函数
    function parseMarkdown(markdown) {
      if (!markdown) return '';
      
      let html = markdown
        .replace(/^### (.*$)/gm, '<h3 style="font-size: 1.25rem; font-weight: 600; margin: 16px 0 8px 0; color: #374151;">$1</h3>')
        .replace(/^## (.*$)/gm, '<h2 style="font-size: 1.5rem; font-weight: 600; margin: 20px 0 12px 0; color: #1f2937;">$1</h2>')
        .replace(/^# (.*$)/gm, '<h1 style="font-size: 1.875rem; font-weight: bold; margin: 24px 0 16px 0; color: #111827; border-bottom: 2px solid #3b82f6; padding-bottom: 8px;">$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```([\s\S]*?)```/g, '<pre style="background: #1f2937; color: #f9fafb; padding: 16px; border-radius: 8px; overflow-x: auto; margin: 16px 0;"><code>$1</code></pre>')
        .replace(/`(.*?)`/g, '<code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.875rem;">$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #3b82f6; text-decoration: underline;">$1</a>')
        .replace(/^> (.*)$/gm, '<blockquote style="border-left: 4px solid #3b82f6; padding-left: 16px; margin: 16px 0; color: #6b7280; font-style: italic;">$1</blockquote>')
        .replace(/^\* (.*)$/gm, '<li style="margin-bottom: 8px;">$1</li>')
        .replace(/^- (.*)$/gm, '<li style="margin-bottom: 8px;">$1</li>')
        .replace(/\n\n/g, '</p><p style="margin-bottom: 16px;">')
        .replace(/\n/g, '<br>');
      
      html = html.replace(/(<li.*?<\/li>)/gs, '<ul style="margin: 16px 0; padding-left: 24px;">$1</ul>');
      
      if (html && !html.startsWith('<')) {
        html = '<p style="margin-bottom: 16px;">' + html + '</p>';
      }
      
      return html;
    }

    // 强制注入样式的函数
    function injectStyles() {
      const style = document.createElement('style');
      style.textContent = `
        /* 强制覆盖CMS样式 */
        .nc-root {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif !important;
          background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%) !important;
        }

        /* 移动端强制优化 */
        @media (max-width: 768px) {
          .nc-root {
            font-size: 16px !important;
          }
          
          .nc-controlPane-widget input[type="text"], 
          .nc-controlPane-widget textarea, 
          .nc-controlPane-widget select {
            font-size: 16px !important;
            padding: 12px !important;
            border-radius: 8px !important;
            border: 2px solid #e5e7eb !important;
            width: 100% !important;
            box-sizing: border-box !important;
          }
          
          .nc-controlPane-widget input[type="text"]:focus, 
          .nc-controlPane-widget textarea:focus, 
          .nc-controlPane-widget select:focus {
            border-color: #3b82f6 !important;
            outline: none !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
          }
          
          .nc-toolbar button {
            min-width: 44px !important;
            min-height: 44px !important;
            padding: 10px !important;
            margin: 2px !important;
          }
          
          .nc-entryEditor {
            padding: 16px !important;
          }
          
          .nc-entryEditor-widget {
            margin-bottom: 20px !important;
          }
        }

        /* 桌面端优化 */
        @media (min-width: 769px) {
          .nc-entryEditor {
            padding: 32px !important;
            max-width: none !important;
          }
        }

        /* 按钮美化 */
        .nc-entryEditor-widgetTop button,
        .nc-toolbar button {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
          color: white !important;
          border: none !important;
          border-radius: 8px !important;
          font-weight: 500 !important;
          transition: all 0.2s ease !important;
        }
        
        .nc-entryEditor-widgetTop button:hover,
        .nc-toolbar button:hover {
          background: linear-gradient(135deg, #1d4ed8, #1e40af) !important;
          transform: translateY(-1px) !important;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
        }

        /* 侧边栏美化 */
        .nc-sidebar {
          background: rgba(255, 255, 255, 0.95) !important;
          backdrop-filter: blur(10px) !important;
          border-right: 1px solid #e5e7eb !important;
        }

        /* 主内容区域 */
        .nc-entryEditor {
          background: rgba(255, 255, 255, 0.8) !important;
          backdrop-filter: blur(10px) !important;
          border-radius: 16px !important;
          margin: 16px !important;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
        }
      `;
      
      document.head.appendChild(style);
      console.log('Custom styles injected!');
    }

    // 等待CMS加载并注册事件
    function initializeCMS() {
      try {
        // 立即注入样式
        injectStyles();

        // 注册ID生成事件
        CMS.registerEventListener({
          name: 'preSave',
          handler: ({ entry }) => {
            console.log('preSave event triggered');
            const data = entry.get('data');
            const currentId = data.get('id');
            
            if (!currentId || currentId.trim() === '' || currentId === '""' || currentId === "''") {
              const newId = generateId();
              console.log('Generated new ID:', newId);
              return entry.get('data').set('id', newId);
            }
            
            console.log('Using existing ID:', currentId);
            return data;
          }
        });

        // 注册预览模板
        CMS.registerPreviewTemplate('blog', ({ entry }) => {
          const title = entry.getIn(['data', 'title']) || '未命名文章';
          const categories = entry.getIn(['data', 'categories']) || '未分类';
          const tags = entry.getIn(['data', 'tags']);
          const date = entry.getIn(['data', 'date']);
          const id = entry.getIn(['data', 'id']) || '待生成';
          const cover = entry.getIn(['data', 'cover']);
          const rawBody = entry.getIn(['data', 'body']) || '';

          const parsedBody = parseMarkdown(rawBody);

          return `
            <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; line-height: 1.6; color: #374151; background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%); min-height: 100vh; padding: 16px;">
              <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: hidden;">
                
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white; padding: 32px 24px; text-align: center;">
                  <h1 style="font-size: 2rem; font-weight: bold; margin: 0 0 8px 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">${title}</h1>
                  <p style="font-size: 1.1rem; opacity: 0.9; margin: 0;">博客文章预览</p>
                </div>
                
                <div style="padding: 24px;">
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid #e2e8f0;">
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                      <span style="font-weight: 600; color: #475569; font-size: 0.9rem;">📝 文章ID</span>
                      <span style="font-family: monospace; color: #1e293b; font-size: 0.875rem; background: white; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0;">${id}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(148, 163, 184, 0.2);">
                      <span style="font-weight: 600; color: #475569; font-size: 0.9rem;">📂 分类</span>
                      <span style="font-family: monospace; color: #1e40af; font-size: 0.875rem; background: #dbeafe; padding: 4px 8px; border-radius: 6px; border: 1px solid #93c5fd;">${categories}</span>
                    </div>
                    
                    <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                      <span style="font-weight: 600; color: #475569; font-size: 0.9rem;">🕒 发布时间</span>
                      <span style="font-family: monospace; color: #1e293b; font-size: 0.875rem; background: white; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0;">${formatDate(date)}</span>
                    </div>
                    
                    ${cover ? `
                      <div style="grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                        <span style="font-weight: 600; color: #475569; font-size: 0.9rem;">🖼️ 封面图片</span>
                        <span style="font-family: monospace; color: #1e293b; font-size: 0.875rem; background: white; padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0; word-break: break-all;">${cover}</span>
                      </div>
                    ` : ''}
                  </div>

                  <div style="margin-bottom: 24px;">
                    <div style="font-weight: 600; color: #475569; font-size: 0.9rem; margin-bottom: 8px;">🏷️ 标签</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      ${renderTags(tags)}
                    </div>
                  </div>

                  <hr style="height: 2px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border: none; margin: 24px 0; border-radius: 1px;">

                  <div style="line-height: 1.7;">
                    ${parsedBody || '<div style="color: #9ca3af; font-style: italic; text-align: center; padding: 40px 20px; background: #f9fafb; border-radius: 8px;">正文内容为空</div>'}
                  </div>
                </div>

                <div style="background: #f8fafc; padding: 16px 24px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 0.875rem; color: #6b7280;">
                  📊 字数约 ${rawBody.length} 字 • 预计阅读时间 ${Math.max(1, Math.ceil(rawBody.length / 400))} 分钟
                </div>
              </div>
            </div>
          `;
        });

        console.log('CMS initialized successfully!');
        
        // 持续检查并重新应用样式
        setInterval(() => {
          const existingStyle = document.querySelector('style[data-custom]');
          if (!existingStyle) {
            const style = document.createElement('style');
            style.setAttribute('data-custom', 'true');
            style.textContent = document.querySelector('style').textContent;
            document.head.appendChild(style);
          }
        }, 2000);

      } catch (error) {
        console.error('Error initializing CMS:', error);
        // 如果初始化失败，稍后重试
        setTimeout(initializeCMS, 2000);
      }
    }

    // 等待CMS加载
    if (typeof CMS !== 'undefined') {
      initializeCMS();
    } else {
      // 如果CMS还没加载，等待加载完成
      const checkCMS = setInterval(() => {
        if (typeof CMS !== 'undefined') {
          clearInterval(checkCMS);
          initializeCMS();
        }
      }, 100);
    }

    // Netlify Identity
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>
</html>
