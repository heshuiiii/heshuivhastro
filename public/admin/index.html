<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>博客管理后台</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // 自动生成文章ID的函数 - 简化版本
    function generateId() {
      const timestamp = Date.now().toString();
      const random = Math.random().toString(36).substring(2, 8);
      return `post-${timestamp}`;
    }
    // return `post-${timestamp}-${random}`;
    
    // 等待DOM加载完成
    document.addEventListener('DOMContentLoaded', function() {
      // 注册preSave事件监听器
      CMS.registerEventListener({
        name: 'preSave',
        handler: ({ entry }) => {
          console.log('preSave event triggered');
          const data = entry.get('data');
          const currentId = data.get('id');
          
          // 如果ID为空、未定义或只有空白字符，生成新ID
          if (!currentId || currentId.trim() === '' || currentId === '""' || currentId === "''") {
            const newId = generateId();
            console.log('Generated new ID:', newId);
            return entry.get('data').set('id', newId);
          }
          
          console.log('Using existing ID:', currentId);
          return data;
        }
      });

      // 注册预览模板 - 修复语法错误
      CMS.registerPreviewTemplate('blog', ({ entry, widgetFor }) => {
        const title = entry.getIn(['data', 'title']) || '未命名文章';
        const body = widgetFor('body');
        const categories = entry.getIn(['data', 'categories']) || '未分类';
        const tags = entry.getIn(['data', 'tags']);
        const date = entry.getIn(['data', 'date']);
        const id = entry.getIn(['data', 'id']) || '未生成';

        // 创建预览HTML
        let html = `
          <div style="padding: 20px; font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto;">
            <h1 style="color: #333; border-bottom: 2px solid #007cba; padding-bottom: 10px;">${title}</h1>
            <div style="color: #666; margin-bottom: 15px; background: #f5f5f5; padding: 10px; border-radius: 5px;">
              <div><strong>文章ID:</strong> ${id}</div>
              <div><strong>分类:</strong> ${categories}</div>
              <div><strong>发布日期:</strong> ${date ? new Date(date).toLocaleString('zh-CN') : '未设置'}</div>
            </div>
        `;

        // 添加标签
        if (tags && tags.length > 0) {
          html += `
            <div style="margin-bottom: 20px;">
              <strong>标签:</strong> 
          `;
          tags.forEach(tag => {
            if (tag && tag.trim()) {
              html += `<span style="background: #007cba; color: white; padding: 2px 8px; margin-right: 5px; border-radius: 12px; font-size: 12px;">${tag}</span>`;
            }
          });
          html += `</div>`;
        }

        html += `
            <div style="border-top: 1px solid #eee; padding-top: 20px; line-height: 1.6;">
        `;

        // 添加正文内容
        if (body) {
          html += body;
        } else {
          html += '<p style="color: #999; font-style: italic;">正文内容为空</p>';
        }

        html += `
            </div>
          </div>
        `;

        return html;
      });

      console.log('CMS event listeners registered');
    });

    // Netlify Identity 自动跳转
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>
</body>
</html>
