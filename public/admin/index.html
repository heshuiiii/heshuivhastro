<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>博客管理后台</title>
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
    }
    
    .nc-root {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif !important;
    }
    
    @media (max-width: 768px) {
      .nc-root {
        font-size: 14px !important;
      }
      
      .nc-toolbar {
        flex-wrap: wrap !important;
        gap: 4px !important;
      }
      
      .nc-toolbar button {
        min-width: 40px !important;
        min-height: 40px !important;
        padding: 8px !important;
      }
      
      .nc-controlPane-widget input[type="text"], 
      .nc-controlPane-widget textarea, 
      .nc-controlPane-widget select {
        font-size: 16px !important;
        padding: 12px !important;
        border-radius: 8px !important;
        width: 100% !important;
      }
      
      .nc-entryEditor {
        padding: 16px !important;
      }
    }
    
    .preview-container {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      line-height: 1.6;
      color: #374151;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
      min-height: 100vh;
      padding: 16px;
    }
    
    .preview-card {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    .preview-header {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      padding: 32px 24px;
      text-align: center;
    }
    
    .preview-title {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
    }
    
    .preview-content {
      padding: 24px;
    }
    
    .info-grid {
      display: grid;
      gap: 12px;
      background: #f8fafc;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }
    
    .info-label {
      font-weight: 600;
      color: #475569;
    }
    
    .info-value {
      font-family: monospace;
      color: #1e293b;
      background: white;
      padding: 4px 8px;
      border-radius: 6px;
    }
    
    .article-content {
      line-height: 1.7;
    }
    
    .article-content h1 {
      font-size: 1.875rem;
      margin: 24px 0 16px 0;
      color: #111827;
    }
    
    .article-content h2 {
      font-size: 1.5rem;
      margin: 20px 0 12px 0;
      color: #1f2937;
    }
    
    .article-content code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // 工具函数
    function generateId() {
      const timestamp = Date.now().toString();
      const random = Math.random().toString(36).substring(2, 8);
      return `post-${timestamp}-${random}`;
    }

    function isEmptyId(id) {
      if (!id) return true;
      if (typeof id !== 'string') return true;
      const trimmed = id.trim();
      return trimmed === '' || trimmed === '""' || trimmed === "''" || trimmed === 'undefined' || trimmed === 'null';
    }

    function parseMarkdown(markdown) {
      if (!markdown) return '';
      
      let html = markdown
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      if (html && !html.startsWith('<')) {
        html = '<p>' + html + '</p>';
      }
      
      return html;
    }

    // 等待 CMS 加载完成
    setTimeout(() => {
      try {
        // 自动生成ID
        CMS.registerEventListener({
          name: 'preSave',
          handler: ({ entry }) => {
            const data = entry.get('data');
            const currentId = data.get('id');
            
            if (isEmptyId(currentId)) {
              const newId = generateId();
              console.log('Generated ID:', newId);
              return entry.get('data').set('id', newId);
            }
            
            return data;
          }
        });

        // 预览模板
        CMS.registerPreviewTemplate('blog', ({ entry }) => {
          const title = entry.getIn(['data', 'title']) || '未命名文章';
          const categories = entry.getIn(['data', 'categories']) || '未分类';
          const date = entry.getIn(['data', 'date']) || '未设置';
          const id = entry.getIn(['data', 'id']) || '将自动生成';
          const body = entry.getIn(['data', 'body']) || '';

          return `
            <div class="preview-container">
              <div class="preview-card">
                <div class="preview-header">
                  <h1 class="preview-title">${title}</h1>
                </div>
                <div class="preview-content">
                  <div class="info-grid">
                    <div class="info-item">
                      <span class="info-label">📝 ID</span>
                      <span class="info-value">${id}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">📂 分类</span>
                      <span class="info-value">${categories}</span>
                    </div>
                    <div class="info-item">
                      <span class="info-label">🕒 日期</span>
                      <span class="info-value">${date}</span>
                    </div>
                  </div>
                  <div class="article-content">
                    ${parseMarkdown(body)}
                  </div>
                </div>
              </div>
            </div>
          `;
        });

        console.log('✅ CMS initialized');
      } catch (error) {
        console.error('❌ Init error:', error);
      }
    }, 1000);
  </script>
</body>
</html>
